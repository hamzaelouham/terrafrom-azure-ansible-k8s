---
- hosts: all
  become: yes
  vars:
    # RedHat Docker repo settings
    docker_yum_gpg_key: https://download.docker.com/linux/centos/gpg
    docker_yum_repo_url: https://download.docker.com/linux/centos/docker-ce.repo
    docker_yum_repo_enable_nightly: '0'
  tasks:
  # ============= Debian/Ubuntu =============
  - name: Install required dependencies (Debian)
    apt:
      name:
        - ca-certificates
        - curl
      state: present
      update_cache: yes
    when: ansible_os_family == 'Debian'

  - name: Create keyrings directory
    file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'
    when: ansible_os_family == 'Debian'

  - name: Add Docker GPG key (Debian)
    get_url:
      url: https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg
      dest: /etc/apt/keyrings/docker.asc
      mode: '0644'
    when: ansible_os_family == 'Debian'

  - name: Add Docker repository (deb822 format)
    copy:
      dest: /etc/apt/sources.list.d/docker.sources
      content: |
        Types: deb
        URIs: https://download.docker.com/linux/{{ ansible_distribution | lower }}
        Suites: {{ ansible_distribution_release }}
        Components: stable
        Signed-By: /etc/apt/keyrings/docker.asc
      mode: '0644'
    when: ansible_os_family == 'Debian'

  - name: Update apt cache after adding Docker repo
    apt:
      update_cache: yes
    when: ansible_os_family == 'Debian'

  # ============= RedHat/CentOS =============
  - name: Add Docker GPG key (RedHat)
    rpm_key:
      key: "{{ docker_yum_gpg_key }}"
      state: present
    when: ansible_os_family == 'RedHat'

  - name: Add Docker repository (RedHat)
    get_url:
      url: "{{ docker_yum_repo_url }}"
      dest: /etc/yum.repos.d/docker-ce.repo
      owner: root
      group: root
      mode: '0644'
    when: ansible_os_family == 'RedHat'

  - name: Configure Docker Nightly repo (RedHat)
    ini_file:
      dest: /etc/yum.repos.d/docker-ce.repo
      section: docker-ce-nightly
      option: enabled
      value: "{{ docker_yum_repo_enable_nightly }}"
      mode: '0644'
    when: ansible_os_family == 'RedHat'

  - name: Ensure container-selinux is installed (RedHat)
    package:
      name: container-selinux
      state: present
    when: ansible_os_family == 'RedHat'

  # ============= Common =============
  - name: Install containerd
    package:
      name: containerd.io
      state: present

  - name: Create containerd config directory
    file:
      path: /etc/containerd
      state: directory
      mode: '0755'

  - name: Get defaults from containerd
    command: containerd config default
    changed_when: false
    register: containerd_config_default

  - name: Prepare containerd config.toml from default config
    copy:
      dest: /tmp/containerd_config.toml
      content: "{{ containerd_config_default.stdout }}"
      mode: '0644'

  - name: Set Cgroup driver to systemd
    lineinfile:
      path: /tmp/containerd_config.toml
      regexp: '^\s*SystemdCgroup\s*='
      insertafter: '.*\[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options\]$'
      line: '            SystemdCgroup = true'
      state: present

  - name: Copy config.toml to /etc/containerd
    copy:
      remote_src: true
      src: /tmp/containerd_config.toml
      dest: /etc/containerd/config.toml
      mode: '0644'

  - name: Cleanup temporary file
    file:
      path: /tmp/containerd_config.toml
      state: absent

  - name: Enable and restart containerd service
    systemd:
      name: containerd
      state: restarted
      enabled: yes
      daemon_reload: yes